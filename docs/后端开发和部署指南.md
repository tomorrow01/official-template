# 后端API服务开发和部署指南

## 目录
1. [项目概述](#1-项目概述)
2. [技术栈](#2-技术栈)
3. [环境要求](#3-环境要求)
4. [项目结构](#4-项目结构)
5. [开发流程](#5-开发流程)
6. [数据库设计](#6-数据库设计)
7. [API开发指南](#7-api开发指南)
8. [文件上传配置](#8-文件上传配置)
9. [构建和部署](#9-构建和部署)
10. [安全考虑](#10-安全考虑)
11. [监控和维护](#11-监控和维护)
12. [常见问题及解决方案](#12-常见问题及解决方案)
13. [开发最佳实践](#13-开发最佳实践)
14. [总结](#14-总结)

---

## 1. 项目概述

后端API服务是基于Node.js和Express框架构建的RESTful API服务，为前端展示网站和管理后台提供数据支持。服务支持文章、轮播图、案例、服务等模块的CRUD操作，并具备文件上传、错误处理、数据库连接降级和默认数据初始化功能。

## 2. 技术栈

| 技术/框架    | 版本        | 用途                          |
|------------|------------|------------------------------|
| Node.js    | -          | JavaScript运行环境           |
| Express.js | -          | Web应用框架                  |
| MongoDB    | -          | NoSQL数据库                  |
| Mongoose   | -          | MongoDB对象建模工具           |
| Multer     | -          | 文件上传中间件                |
| CORS       | -          | 跨域资源共享中间件            |

## 3. 环境要求

### 3.1 必备环境

- Node.js (v14.x 或更高版本)
- npm (v6.x 或更高版本) 或 yarn
- MongoDB (v4.x 或更高版本)
- Git

### 3.2 推荐工具

- Visual Studio Code
- MongoDB Compass (GUI管理工具)
- Postman (API测试工具)
- ESLint

## 4. 项目结构

```
backend/
├── src/
│   ├── data/             # 数据文件
│   ├── models/           # 数据模型
│   │   ├── Banner.js     # 轮播图模型
│   │   └── ...           # 其他模型
│   ├── routes/           # 路由定义
│   │   ├── articles.js   # 文章路由
│   │   ├── banners.js    # 轮播图路由
│   │   └── ...           # 其他路由
│   ├── utils/            # 工具函数
│   │   ├── db.js         # 数据库连接工具
│   │   └── response.js   # 响应处理工具
│   └── index.js          # 入口文件
├── uploads/              # 上传文件目录
├── package.json          # 项目配置文件
└── .env.example          # 环境变量示例文件
```

## 5. 开发流程

### 5.1 克隆项目

```bash
# 克隆仓库
cd /Users/xuyumei/code/project/official-template
# 进入后端目录
cd backend
```

### 5.2 安装依赖

使用npm安装依赖：

```bash
npm install
```

或使用yarn：

```bash
yarn install
```

### 5.3 配置环境变量

创建`.env`文件，参考`.env.example`：

```env
# 数据库连接字符串
MONGO_URI=mongodb://localhost:27017/official_template

# 服务器端口
PORT=3001

# 文件上传大小限制（MB）
UPLOAD_LIMIT=5

# JWT密钥（用于认证，可选）
JWT_SECRET=your_jwt_secret_key
```

### 5.4 启动MongoDB

确保MongoDB服务正在运行：

```bash
# macOS
brew services start mongodb-community

# Linux
# 取决于安装方式，通常为：
sudo systemctl start mongod

# Windows
# 使用MongoDB Compass或命令行启动
```

### 5.5 启动开发服务器

```bash
# 开发模式
npm run dev

# 或直接运行
node src/index.js
```

服务将在配置的端口（默认为3001）启动。您可以通过 http://localhost:3001/api 访问API接口。

## 6. 数据库设计

### 6.1 数据模型

#### 6.1.1 轮播图模型 (Banner)

```javascript
// models/Banner.js
const mongoose = require('mongoose');

const BannerSchema = new mongoose.Schema({
  title: {
    type: String,
    default: ''
  },
  imageUrl: {
    type: String,
    required: [true, '请上传轮播图'],
  },
  link: {
    type: String,
    default: ''
  },
  order: {
    type: Number,
    default: 0,
    min: 0
  },
  isActive: {
    type: Boolean,
    default: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});

module.exports = mongoose.model('Banner', BannerSchema);
```

#### 6.1.2 其他模型

其他模型（如Article、Service、Case等）遵循类似的设计模式，包含标题、内容、图片、排序和状态等字段。

### 6.2 默认数据初始化

系统启动时会自动检查数据库中是否存在数据，如果不存在则插入默认数据。初始化逻辑位于`utils/db.js`中的`insertDefaultData`函数。

默认数据包括：
- 轮播图数据
- 服务数据
- 案例数据
- 文章数据

## 7. API开发指南

### 7.1 创建新的路由模块

在`routes`目录下创建新的路由文件，例如创建一个新产品路由：

```javascript
// routes/products.js
const express = require('express');
const router = express.Router();
const Product = require('../models/Product');
const { sendResponse } = require('../utils/response');
const { isDbConnected } = require('../utils/db');

// 获取所有产品
router.get('/', async (req, res) => {
  try {
    // 检查数据库连接状态
    if (!isDbConnected()) {
      // 返回模拟数据
      return sendResponse(res, 200, true, mockProducts, '使用模拟数据');
    }
    
    const products = await Product.find().sort({ order: 1 });
    sendResponse(res, 200, true, products, '获取产品列表成功');
  } catch (error) {
    console.error('获取产品列表失败:', error);
    sendResponse(res, 500, false, null, '获取产品列表失败');
  }
});

// 其他路由...

module.exports = router;
```

### 7.2 在入口文件中注册路由

在`index.js`中注册新的路由：

```javascript
// 导入新产品路由
const productsRouter = require('./routes/products');

// 注册路由
app.use('/api/products', productsRouter);
```

### 7.3 创建新的数据模型

在`models`目录下创建新的模型文件：

```javascript
// models/Product.js
const mongoose = require('mongoose');

const ProductSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, '产品名称不能为空'],
  },
  description: String,
  price: Number,
  imageUrl: String,
  order: {
    type: Number,
    default: 0,
    min: 0
  },
  isActive: {
    type: Boolean,
    default: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});

module.exports = mongoose.model('Product', ProductSchema);
```

## 8. 文件上传配置

后端支持图片文件上传，配置位于`index.js`文件中：

```javascript
const multer = require('multer');
const path = require('path');

// 配置文件上传
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, './uploads/');
  },
  filename: function (req, file, cb) {
    cb(null, Date.now() + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB限制
  },
  fileFilter: function (req, file, cb) {
    const filetypes = /jpeg|jpg|png|gif|webp/;
    const mimetype = filetypes.test(file.mimetype);
    const extname = filetypes.test(path.extname(file.originalname).toLowerCase());
    
    if (mimetype && extname) {
      return cb(null, true);
    }
    
    cb(new Error('只支持图片格式(jpeg, jpg, png, gif, webp)'));
  }
});
```

## 9. 构建和部署

### 9.1 直接部署

1. 将项目文件复制到服务器
2. 安装依赖：

```bash
npm install --production
```

3. 配置环境变量
4. 启动服务：

```bash
# 使用PM2进程管理器
npm install -g pm2
pm2 start src/index.js --name "official-backend"
pm2 startup
pm2 save
```

### 9.2 Docker部署

创建Dockerfile：

```dockerfile
# 使用Node.js官方镜像作为基础镜像
FROM node:16-alpine

# 设置工作目录
WORKDIR /app

# 复制package.json和package-lock.json
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制项目文件
COPY . .

# 创建上传目录
RUN mkdir -p uploads

# 暴露端口
EXPOSE 3001

# 启动应用
CMD ["node", "src/index.js"]
```

创建docker-compose.yml：

```yaml
version: '3'

services:
  backend:
    build: .
    ports:
      - "3001:3001"
    environment:
      - MONGO_URI=mongodb://mongo:27017/official_template
      - PORT=3001
      - UPLOAD_LIMIT=5
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      - mongo
    restart: always

  mongo:
    image: mongo:latest
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: always

volumes:
  mongo-data:
```

构建和启动：

```bash
docker-compose up -d
```

## 10. 安全考虑

### 10.1 文件上传安全

- 限制文件类型，只允许常见图片格式
- 设置文件大小限制，防止大文件攻击
- 重命名上传文件，避免路径遍历攻击

### 10.2 环境变量管理

- 敏感信息（如数据库连接字符串、JWT密钥）通过环境变量配置
- 不要将`.env`文件提交到版本控制系统
- 提供`.env.example`作为配置示例

### 10.3 错误处理

- 统一错误处理，避免泄露敏感信息
- 记录错误日志，但返回给客户端的信息应经过过滤

## 11. 监控和维护

### 11.1 日志记录

系统会记录API请求和错误信息，可以通过以下方式增强日志功能：

```javascript
// 在index.js中添加请求日志中间件
app.use((req, res, next) => {
  const startTime = Date.now();
  const originalSend = res.send;
  
  res.send = function(body) {
    const responseTime = Date.now() - startTime;
    console.log(`[${new Date().toISOString()}] ${req.method} ${req.url} ${res.statusCode} ${responseTime}ms`);
    return originalSend.call(this, body);
  };
  
  next();
});
```

### 11.2 数据库维护

- 定期备份数据库
- 监控数据库连接和性能
- 清理过期数据和临时文件

## 12. 常见问题及解决方案

### 12.1 MongoDB连接失败

**问题**：无法连接到MongoDB数据库

**解决方案**：
- 检查MongoDB服务是否正在运行
- 验证连接字符串是否正确
- 确保数据库用户有权限访问
- 检查防火墙设置，确保端口27017开放

### 12.2 文件上传失败

**问题**：无法上传文件或上传后无法访问

**解决方案**：
- 检查uploads目录权限
- 验证文件类型和大小是否符合限制
- 确保express.static中间件正确配置，以提供静态文件访问

### 12.3 端口冲突

**问题**：服务无法启动，提示端口已被占用

**解决方案**：
- 修改`.env`文件中的PORT配置为其他端口
- 找出占用端口的进程并终止

## 13. 开发最佳实践

### 13.1 代码组织

- 按功能模块组织代码（routes, models, utils）
- 路由处理和业务逻辑分离
- 使用中间件处理通用功能（日志、错误处理等）

### 13.2 API设计

- 遵循RESTful API设计原则
- 使用HTTP状态码表示请求结果
- 返回统一格式的响应数据
- 提供足够的错误信息

### 13.3 数据库操作

- 使用Mongoose的错误验证功能
- 避免在循环中进行数据库操作
- 使用索引优化查询性能
- 实现数据库连接失败的降级处理

## 14. 总结

本指南提供了后端API服务的开发和部署流程，包括环境配置、项目结构、数据库设计、API开发规范和部署方式。遵循本指南可以确保项目的开发效率和代码质量，同时顺利完成部署上线。